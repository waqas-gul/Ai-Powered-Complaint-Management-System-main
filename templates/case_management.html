{% extends "base.html" %}

{% block title %}Case Management - Complaint Management System{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-tasks"></i>
            Case Management
        </h3>
    </div>
    <div class="card-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <p style="color: var(--gray);">Manage and track all complaint cases</p>
            <button class="btn btn-outline" id="refresh-cases">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
        </div>

        <div class="filters" style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
            <select class="form-control" style="width: auto;" id="status-filter">
                <option value="">All Status</option>
                <option value="Pending">Pending</option>
                <option value="Assigned">Assigned</option>
                <option value="Completed">Completed</option>
            </select>
            
            <select class="form-control" style="width: auto;" id="department-filter">
                <option value="">All Departments</option>
                <!-- Departments will be loaded here -->
            </select>
        </div>

        <div class="cases-list" id="cases-list">
            <!-- Cases will be loaded here -->
        </div>
    </div>
</div>

<!-- Case Details Modal -->
<div class="modal" id="case-details-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-file-alt"></i>
                Case Details
            </h3>
            <button class="close-modal" id="close-case-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="case-modal-body">
            <!-- Case details will be loaded here -->
        </div>
    </div>
</div>

<!-- Update Case Modal -->
<div class="modal" id="update-case-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-edit"></i>
                Update Case
            </h3>
            <button class="close-modal" id="close-update-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="update-modal-body">
            <!-- Update form will be loaded here -->
        </div>
    </div>
</div>

<style>
    .cases-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--white);
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .cases-table th,
    .cases-table td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid var(--light-gray);
    }

    .cases-table th {
        background: var(--light);
        font-weight: 600;
        color: var(--dark);
        font-size: 0.9rem;
    }

    .cases-table tr:hover {
        background: var(--light);
    }

    .case-actions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--gray);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 16px;
        color: var(--light-gray);
    }

    @media (max-width: 768px) {
        .cases-table {
            display: block;
            overflow-x: auto;
        }
        
        .filters {
            flex-direction: column;
        }
        
        .filters select {
            width: 100% !important;
        }
        
        .case-actions {
            flex-direction: column;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const refreshBtn = document.getElementById('refresh-cases');
        const casesList = document.getElementById('cases-list');
        const statusFilter = document.getElementById('status-filter');
        const departmentFilter = document.getElementById('department-filter');
        const caseDetailsModal = document.getElementById('case-details-modal');
        const closeCaseModal = document.getElementById('close-case-modal');
        const caseModalBody = document.getElementById('case-modal-body');
        const updateCaseModal = document.getElementById('update-case-modal');
        const closeUpdateModal = document.getElementById('close-update-modal');
        const updateModalBody = document.getElementById('update-modal-body');

        let allCases = [];
        let allDepartments = [];
        let currentCaseId = null;

        // Load cases and departments
        loadCases();
        loadDepartments();

        // Refresh cases
        refreshBtn.addEventListener('click', function() {
            loadCases();
        });

        // Filter cases
        statusFilter.addEventListener('change', filterCases);
        departmentFilter.addEventListener('change', filterCases);

        // Close modals
        closeCaseModal.addEventListener('click', function() {
            caseDetailsModal.style.display = 'none';
        });

        closeUpdateModal.addEventListener('click', function() {
            updateCaseModal.style.display = 'none';
        });

        function loadCases() {
            fetch('/api/complaints')
                .then(response => response.json())
                .then(cases => {
                    allCases = cases;
                    renderCases(cases);
                })
                .catch(error => {
                    console.error('Error loading cases:', error);
                    casesList.innerHTML = '<p>Error loading cases</p>';
                });
        }

        function loadDepartments() {
            fetch('/api/departments')
                .then(response => response.json())
                .then(departments => {
                    allDepartments = departments;
                    
                    let html = '<option value="">All Departments</option>';
                    departments.forEach(dept => {
                        html += `<option value="${dept.name}">${dept.name}</option>`;
                    });
                    departmentFilter.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading departments:', error);
                });
        }

        function filterCases() {
            const status = statusFilter.value;
            const department = departmentFilter.value;

            let filteredCases = allCases;

            if (status) {
                filteredCases = filteredCases.filter(caseItem => caseItem.resolution_status === status);
            }

            if (department) {
                filteredCases = filteredCases.filter(caseItem => caseItem.forwarded_to === department);
            }

            renderCases(filteredCases);
        }

        function renderCases(cases) {
            if (cases.length === 0) {
                casesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No Cases Found</h3>
                        <p>No complaints match the current filters</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="cases-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Category</th>
                            <th>Department</th>
                            <th>Status</th>
                            <th>Received</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            cases.forEach(caseItem => {
                const statusClass = getStatusClass(caseItem.resolution_status);
                const receivedDate = new Date(caseItem.timestamp).toLocaleDateString();

                html += `
                    <tr>
                        <td>#${caseItem.id}</td>
                        <td>${caseItem.predicted_category}</td>
                        <td>${caseItem.forwarded_to || 'Not Assigned'}</td>
                        <td>
                            <div class="status-badge ${statusClass}">
                                <i class="fas ${getStatusIcon(caseItem.resolution_status)}"></i>
                                ${caseItem.resolution_status}
                            </div>
                        </td>
                        <td>${receivedDate}</td>
                        <td>
                            <div class="case-actions">
                                <button class="btn btn-outline btn-sm view-case" data-id="${caseItem.id}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-primary btn-sm update-case" data-id="${caseItem.id}">
                                    <i class="fas fa-edit"></i> Update
                                </button>
                                ${!caseItem.case_completed && caseItem.forwarded ? `
                                <button class="btn btn-success btn-sm complete-case" data-id="${caseItem.id}">
                                    <i class="fas fa-check"></i> Complete
                                </button>
                                ` : ''}
                                <button class="btn btn-danger btn-sm delete-case" data-id="${caseItem.id}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            casesList.innerHTML = html;

            // Add event listeners
            document.querySelectorAll('.view-case').forEach(button => {
                button.addEventListener('click', function() {
                    const caseId = this.getAttribute('data-id');
                    showCaseDetails(caseId);
                });
            });

            document.querySelectorAll('.update-case').forEach(button => {
                button.addEventListener('click', function() {
                    const caseId = this.getAttribute('data-id');
                    showUpdateCaseForm(caseId);
                });
            });

            document.querySelectorAll('.complete-case').forEach(button => {
                button.addEventListener('click', function() {
                    const caseId = this.getAttribute('data-id');
                    completeCase(caseId);
                });
            });

            document.querySelectorAll('.delete-case').forEach(button => {
                button.addEventListener('click', function() {
                    const caseId = this.getAttribute('data-id');
                    deleteCase(caseId);
                });
            });
        }

        function getStatusClass(status) {
            const statusClasses = {
                'Pending': 'status-pending',
                'Assigned': 'status-assigned',
                'Completed': 'status-completed'
            };
            return statusClasses[status] || 'status-pending';
        }

        function getStatusIcon(status) {
            const statusIcons = {
                'Pending': 'fa-clock',
                'Assigned': 'fa-paper-plane',
                'Completed': 'fa-check'
            };
            return statusIcons[status] || 'fa-clock';
        }

        function showCaseDetails(caseId) {
            fetch(`/api/complaint_details/${caseId}`)
                .then(response => response.json())
                .then(caseDetails => {
                    if (caseDetails.error) {
                        caseModalBody.innerHTML = `<p>${caseDetails.error}</p>`;
                    } else {
                        const statusClass = getStatusClass(caseDetails.resolution_status);
                        
                        caseModalBody.innerHTML = `
                            <div style="display: grid; gap: 16px;">
                                <div>
                                    <div style="font-weight: 600; color: var(--dark); margin-bottom: 4px;">Complaint Text</div>
                                    <div style="background: var(--light); padding: 12px; border-radius: var(--border-radius-sm);">
                                        ${caseDetails.complaint_text}
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--dark); margin-bottom: 4px;">Category</div>
                                        <div>${caseDetails.predicted_category}</div>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--dark); margin-bottom: 4px;">Status</div>
                                        <div class="status-badge ${statusClass}">
                                            <i class="fas ${getStatusIcon(caseDetails.resolution_status)}"></i>
                                            ${caseDetails.resolution_status}
                                        </div>
                                    </div>
                                </div>
                                
                                ${caseDetails.forwarded_to ? `
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--dark); margin-bottom: 4px;">Assigned Department</div>
                                        <div>${caseDetails.forwarded_to}</div>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--dark); margin-bottom: 4px;">Assigned At</div>
                                        <div>${new Date(caseDetails.forwarded_at).toLocaleString()}</div>
                                    </div>
                                </div>
                                ` : `
                                <div>
                                    <div style="font-weight: 600; color: var(--dark); margin-bottom: 4px;">Department Assignment</div>
                                    <div style="color: var(--warning);">Not assigned to any department</div>
                                </div>
                                `}
                                
                                ${caseDetails.case_completed ? `
                                <div>
                                    <div style="font-weight: 600; color: var(--dark); margin-bottom: 4px;">Completed At</div>
                                    <div>${new Date(caseDetails.completed_at).toLocaleString()}</div>
                                </div>
                                ` : ''}
                                
                                <div style="display: flex; gap: 12px; margin-top: 16px;">
                                    ${!caseDetails.case_completed ? `
                                    <button class="btn btn-primary" id="update-from-details" data-id="${caseDetails.id}">
                                        <i class="fas fa-edit"></i> Update Case
                                    </button>
                                    ` : ''}
                                    ${!caseDetails.case_completed && caseDetails.forwarded ? `
                                    <button class="btn btn-success" id="complete-from-details" data-id="${caseDetails.id}">
                                        <i class="fas fa-check"></i> Mark as Completed
                                    </button>
                                    ` : ''}
                                    <button class="btn btn-danger" id="delete-from-details" data-id="${caseDetails.id}">
                                        <i class="fas fa-trash"></i> Delete Case
                                    </button>
                                </div>
                            </div>
                        `;

                        // Add event listeners to buttons in details modal
                        const updateBtn = document.getElementById('update-from-details');
                        if (updateBtn) {
                            updateBtn.addEventListener('click', function() {
                                caseDetailsModal.style.display = 'none';
                                showUpdateCaseForm(caseDetails.id);
                            });
                        }

                        const completeBtn = document.getElementById('complete-from-details');
                        if (completeBtn) {
                            completeBtn.addEventListener('click', function() {
                                caseDetailsModal.style.display = 'none';
                                completeCase(caseDetails.id);
                            });
                        }

                        const deleteBtn = document.getElementById('delete-from-details');
                        if (deleteBtn) {
                            deleteBtn.addEventListener('click', function() {
                                caseDetailsModal.style.display = 'none';
                                deleteCase(caseDetails.id);
                            });
                        }
                    }
                    
                    caseDetailsModal.style.display = 'flex';
                })
                .catch(error => {
                    console.error('Error loading case details:', error);
                    caseModalBody.innerHTML = '<p>Error loading case details</p>';
                    caseDetailsModal.style.display = 'flex';
                });
        }

        function showUpdateCaseForm(caseId) {
            fetch(`/api/complaint_details/${caseId}`)
                .then(response => response.json())
                .then(caseDetails => {
                    if (caseDetails.error) {
                        updateModalBody.innerHTML = `<p>${caseDetails.error}</p>`;
                    } else {
                        updateModalBody.innerHTML = `
                            <div style="display: grid; gap: 16px;">
                                <div>
                                    <div style="font-weight: 600; color: var(--dark); margin-bottom: 8px;">Complaint</div>
                                    <div style="background: var(--light); padding: 12px; border-radius: var(--border-radius-sm); font-size: 0.9rem;">
                                        ${caseDetails.complaint_text}
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="font-weight: 600; color: var(--dark); margin-bottom: 8px;">Current Status</div>
                                    <div class="status-badge ${getStatusClass(caseDetails.resolution_status)}">
                                        <i class="fas ${getStatusIcon(caseDetails.resolution_status)}"></i>
                                        ${caseDetails.resolution_status}
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Update Status</label>
                                    <select class="form-control" id="update-status">
                                        <option value="Pending" ${caseDetails.resolution_status === 'Pending' ? 'selected' : ''}>Pending</option>
                                        <option value="Assigned" ${caseDetails.resolution_status === 'Assigned' ? 'selected' : ''}>Assigned</option>
                                        <option value="Completed" ${caseDetails.resolution_status === 'Completed' ? 'selected' : ''}>Completed</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Assign to Department</label>
                                    <select class="form-control" id="update-department">
                                        <option value="">No change</option>
                                        ${allDepartments.map(dept => 
                                            `<option value="${dept.id}" ${caseDetails.forwarded_to === dept.name ? 'selected' : ''}>${dept.name}</option>`
                                        ).join('')}
                                    </select>
                                    <small style="color: var(--gray); margin-top: 4px; display: block;">
                                        Select a department to assign or reassign this case
                                    </small>
                                </div>
                                
                                <div style="display: flex; gap: 12px; margin-top: 16px;">
                                    <button class="btn btn-success" id="save-update">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                    <button class="btn btn-outline" id="cancel-update">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        `;

                        // Add event listeners
                        document.getElementById('save-update').addEventListener('click', function() {
                            saveCaseUpdate(caseId);
                        });

                        document.getElementById('cancel-update').addEventListener('click', function() {
                            updateCaseModal.style.display = 'none';
                        });
                    }
                    
                    updateCaseModal.style.display = 'flex';
                })
                .catch(error => {
                    console.error('Error loading case details for update:', error);
                    updateModalBody.innerHTML = '<p>Error loading case details</p>';
                    updateCaseModal.style.display = 'flex';
                });
        }

        function saveCaseUpdate(caseId) {
            const status = document.getElementById('update-status').value;
            const department = document.getElementById('update-department').value;

            if (!status && !department) {
                showNotification('Please make at least one change', 'warning');
                return;
            }

            fetch('/update_case', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    complaint_id: caseId,
                    department_id: department || null,
                    resolution_status: status
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateCaseModal.style.display = 'none';
                    showNotification(data.message, 'success');
                    loadCases();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error updating case:', error);
                showNotification('Error updating case', 'error');
            });
        }

        function completeCase(caseId) {
            if (!confirm('Are you sure you want to mark this case as completed?')) {
                return;
            }

            fetch('/complete_case', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    complaint_id: caseId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Case marked as completed!', 'success');
                    loadCases();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error completing case:', error);
                showNotification('Error completing case', 'error');
            });
        }

        function deleteCase(caseId) {
            if (!confirm('Are you sure you want to delete this case? This action cannot be undone.')) {
                return;
            }

            fetch('/delete_case', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    complaint_id: caseId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Case deleted successfully!', 'success');
                    loadCases();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting case:', error);
                showNotification('Error deleting case', 'error');
            });
        }
    });
</script>
{% endblock %}